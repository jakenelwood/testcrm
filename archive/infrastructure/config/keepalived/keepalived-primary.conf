# ðŸ”„ Keepalived Configuration for Primary HAProxy Node
# ubuntu-8gb-hil-1 (5.78.103.224) - Primary VRRP Master
# Part of the GardenOS high-availability CRM stack

global_defs {
    # Unique router ID for this cluster
    router_id GARDENOS_HAPROXY_PRIMARY
    
    # Enable script security
    enable_script_security
    
    # Notification settings
    notification_email {
        admin@gardenos.local
    }
    notification_email_from keepalived@gardenos.local
    smtp_server localhost
    smtp_connect_timeout 30
}

# Health check script for HAProxy
vrrp_script chk_haproxy {
    script "/usr/local/bin/check_haproxy.sh"
    interval 2          # Check every 2 seconds
    weight -2           # Reduce priority by 2 if script fails
    fall 3              # Require 3 failures before considering down
    rise 2              # Require 2 successes before considering up
    timeout 3           # Script timeout
    user root           # Run as root user
}

# VRRP instance for HAProxy Virtual IP
vrrp_instance VI_HAPROXY {
    state MASTER                    # This is the primary node
    interface eth0                  # Network interface (adjust if different)
    virtual_router_id 51           # Must be same on all nodes
    priority 110                   # Highest priority (primary)
    advert_int 1                   # Advertisement interval
    
    # Authentication
    authentication {
        auth_type PASS
        auth_pass CRM_VRRP_2025
    }
    
    # Virtual IP address (Hetzner Floating IP)
    virtual_ipaddress {
        5.78.31.2/32 dev eth0       # Main floating IP
    }
    
    # Track the HAProxy health check script
    track_script {
        chk_haproxy
    }
    
    # Notification scripts
    notify_master "/usr/local/bin/keepalived_notify.sh MASTER"
    notify_backup "/usr/local/bin/keepalived_notify.sh BACKUP"
    notify_fault "/usr/local/bin/keepalived_notify.sh FAULT"
    
    # VRRP settings (removed nopreempt and preempt_delay for MASTER state)
}

# Virtual server for PostgreSQL primary (port 5000)
virtual_server 5.78.31.2 5000 {
    delay_loop 6                   # Health check interval
    lb_algo rr                     # Round robin
    lb_kind NAT                    # NAT mode
    persistence_timeout 50         # Session persistence
    protocol TCP                   # TCP protocol
    
    # Real server (local HAProxy)
    real_server 127.0.0.1 5000 {
        weight 1
        TCP_CHECK {
            connect_timeout 3
            retry 3
            delay_before_retry 3
            connect_port 5000
        }
    }
}

# Virtual server for PostgreSQL replicas (port 5001)
virtual_server 5.78.31.2 5001 {
    delay_loop 6
    lb_algo rr
    lb_kind NAT
    persistence_timeout 50
    protocol TCP
    
    real_server 127.0.0.1 5001 {
        weight 1
        TCP_CHECK {
            connect_timeout 3
            retry 3
            delay_before_retry 3
            connect_port 5001
        }
    }
}

# Virtual server for K3s API (port 6443)
virtual_server 5.78.31.2 6443 {
    delay_loop 6
    lb_algo rr
    lb_kind NAT
    persistence_timeout 50
    protocol TCP
    
    real_server 127.0.0.1 6443 {
        weight 1
        TCP_CHECK {
            connect_timeout 3
            retry 3
            delay_before_retry 3
            connect_port 6443
        }
    }
}

# Virtual server for HAProxy stats (port 7000)
virtual_server 5.78.31.2 7000 {
    delay_loop 6
    lb_algo rr
    lb_kind NAT
    persistence_timeout 50
    protocol TCP
    
    real_server 127.0.0.1 7000 {
        weight 1
        TCP_CHECK {
            connect_timeout 3
            retry 3
            delay_before_retry 3
            connect_port 7000
        }
    }
}
